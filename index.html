<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://unpkg.com/socket.io-client@3.1.1/dist/socket.io.min.js"></script>
</head>
<body>
<b>
    Open the console
</b>

<script>
    const endpoint = `ws://${window.location.host}`;

    let hasError;
    let messageId = 0;
    let lastResponseDate = Date.now();
    const heartbeatTimeout = 5000; // 5 seconds

    const socket = io(endpoint, {transports: ["websocket"]});
    socket.on('connect', () => {
        console.log(`Connected to ${endpoint}`)
        sendCurrentDate();
    });
    socket.on('disconnect', (reason) => console.log(`Closed`, {reason}));
    socket.on('message', (message) => {
        console.log(message);
        lastResponseDate = Date.now();
    });
    socket.on('connect_error', (error) => {
        hasError = true;
        console.error('Transport error: ', error)
        console.log('Closing Socket by the error')
        socket.close();
    });

    function sendCurrentDate() {
        if (hasError) {
            return;
        }

        if (socket.connected) {
            const message = `ping ${++messageId}`;
            console.log(message);
            socket.send(message);
        }
        if (socket.connected) {
            setTimeout(sendCurrentDate, 1000);
        }
    }

    let intervalId = setInterval(() => {
        if (Date.now() - lastResponseDate > heartbeatTimeout) {
            if (socket.connected) {
                console.log('Closing WebSocket by the heartbeat')
                socket.close();
                clearInterval(intervalId);
            }
        }
    }, 500)
</script>
</body>
</html>
